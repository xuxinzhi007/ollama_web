<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Web UI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🤖</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileSidebar()"></div>
    
    <div class="container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <h3 style="margin-top: 5px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a10 10 0 1 0 0 20 10 10 0 1 0 0-20z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                我的智能体
            </h3>
            
            <button class="new-agent-btn" onclick="createNewAgent()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                新建智能体
            </button>
            
            <div id="agentList" style="flex: 1; overflow-y: auto;"></div>
            
            <div id="noAgents" style="padding: 40px 10px; color: var(--text-tertiary); text-align: center; display: none;">
                <svg width="40" height="40" style="opacity: 0.3; margin-bottom: 10px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                </svg>
                <div>暂无智能体</div>
            </div>
            
            <div class="sidebar-footer" style="margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <button onclick="toggleManagePanel()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.03); color: var(--text-secondary); border-radius: var(--radius-md); font-size: 13px; justify-content: flex-start; gap: 10px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                    管理底座模型
                </button>
            </div>
        </div>
        
        <!-- 主区域 -->
        <div class="main">
            <div class="header">
                <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">☰</button>
                
                <button id="backToHomeBtn" onclick="backToHome()" title="返回首页" style="display: none; padding: 6px 12px; background: rgba(255,255,255,0.05); border-radius: 6px; color: var(--text-secondary); font-size: 13px; margin-right: 12px; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    </svg>
                    <span>首页</span>
                </button>
                
                <div style="flex: 1; font-size: 15px; font-weight: 600; color: var(--text-primary);" id="currentAgentName">
                    选择一个智能体开始对话
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <label id="keepHistoryLabel" style="display: none; align-items: center; gap: 6px; cursor: pointer; color: var(--text-secondary); font-size: 13px;">
                        <input type="checkbox" id="keepHistory" checked style="width: 14px; height: 14px; margin: 0;">
                        <span>保留历史</span>
                    </label>
                    
                    <button id="clearChatBtn" onclick="clearChat()" style="display: none; padding: 6px 10px; color: var(--text-tertiary); font-size: 13px; gap: 4px; background: transparent;" title="清空对话">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        <span class="btn-text">清空</span>
                    </button>
                </div>
            </div>
            
            <div class="chat-area" id="chatArea" style="display: none;">
                <div class="chat-container-inner" id="chatContainerInner">
                    <!-- 消息将插入到这里 -->
                </div>
            </div>
            
            <!-- 欢迎页面 -->
            <div id="welcomeScreen" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; background: rgba(0,0,0,0.1);">
                <!-- Tab 导航 -->
                <div style="display: flex; gap: 0; border-bottom: 1px solid var(--border-color); padding: 0 24px;">
                    <!-- 移除内联样式，只保留 class -->
                    <button class="welcome-tab active" data-tab="quick" onclick="switchWelcomeTab('quick')">
                        快速开始
                    </button>
                    <button class="welcome-tab" data-tab="plaza" onclick="switchWelcomeTab('plaza')">
                        智能体广场
                    </button>
                </div>
                
                <!-- 快速开始内容 -->
                <div id="quickTab" class="welcome-tab-content" style="flex: 1; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
                    <div style="max-width: 680px; width: 100%;">
                        <div style="text-align: center; margin-bottom: 50px;" class="fade-in">
                            <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: linear-gradient(135deg, #2563eb, #7c3aed); border-radius: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <path d="M12 2a10 10 0 1 0 0 20 10 10 0 1 0 0-20z"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                            </div>
                            <h1 style="margin: 0 0 12px 0; font-size: 28px; font-weight: 600; letter-spacing: -0.5px;">Ollama Web UI</h1>
                            <p style="color: var(--text-secondary); font-size: 16px; max-width: 400px; margin: 0 auto;">本地 AI 模型的现代化交互界面，简单、安全、高效。</p>
                        </div>
                    
                        <div id="recentAgents" style="margin-bottom: 30px;"></div>
                        
                        <div class="welcome-grid">
                            <button onclick="createNewAgent()" class="welcome-card">
                                <div class="card-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                                </div>
                                <div class="card-title">创建新智能体</div>
                                <div class="card-desc">自定义角色、参数和提示词</div>
                            </button>
                            
                            <button onclick="toggleManagePanel()" class="welcome-card">
                                <div class="card-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                </div>
                                <div class="card-title">管理模型库</div>
                                <div class="card-desc">拉取、删除和管理底座模型</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 智能体广场内容 -->
                <div id="plazaTab" class="welcome-tab-content" style="flex: 1; display: none; overflow-y: auto;">
                    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                        <div style="margin-bottom: 24px;">
                            <h2 style="font-size: 20px; font-weight: 600; color: var(--text-primary);">所有智能体</h2>
                            <p style="color: var(--text-secondary); font-size: 14px;">管理和切换已创建的 AI 助手</p>
                        </div>
                        
                        <div id="plazaAgentList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            <!-- 动态加载智能体卡片 -->
                        </div>
                        
                        <div id="plazaEmpty" style="display: none; text-align: center; padding: 60px 20px;">
                            <div style="color: var(--text-tertiary); margin-bottom: 20px;">暂无智能体</div>
                            <button class="primary" onclick="createNewAgent()">立即创建</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-area" id="inputArea" style="display: none;">
                <div class="input-box">
                    <textarea id="userInput" placeholder="输入消息... (Shift+Enter 换行)" onkeydown="handleInputKeydown(event)"></textarea>
                    <button onclick="sendMessage()" class="primary" style="border-radius: 8px; width: 40px; height: 40px; padding: 0;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transform: rotate(45deg) translateX(-2px);">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
                <div style="text-align: center; font-size: 12px; color: var(--text-tertiary); margin-top: 10px;">
                    AI 可能会产生错误信息，请核对重要事实。
                </div>
            </div>
        </div>
    </div>

    <!-- 管理底座模型面板 -->
    <div id="managePanel" class="modal-overlay" style="display: none;" onclick="closeManagePanel()">
        <div class="modal-content" style="max-width: 600px; margin: 5vh auto;" onclick="event.stopPropagation()">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px;">模型管理</h3>
                <button onclick="closeManagePanel()" style="background: transparent; color: var(--text-tertiary); font-size: 20px;">✕</button>
            </div>
            
            <div style="padding: 20px;">
                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-secondary);">拉取新模型</h4>
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <input type="text" id="pullModelInput" placeholder="例如: qwen2.5:7b, llama3" style="flex: 1;">
                    <button onclick="pullModel()" class="primary" id="pullBtn" style="white-space: nowrap;">拉取模型</button>
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-secondary); font-size: 13px;">
                        <input type="radio" name="pullMethod" value="api" checked onchange="updatePullMethod()">
                        API 模式
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-secondary); font-size: 13px;">
                        <input type="radio" name="pullMethod" value="cli" onchange="updatePullMethod()">
                        命令行模式
                    </label>
                </div>
                
                <div id="pullCommandHint" style="display: none; margin-bottom: 20px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border: 1px dashed var(--border-color);">
                    <div style="font-family: monospace; color: #10b981; font-size: 13px;" id="pullCommand"></div>
                </div>
                
                <div id="pullProgress" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; color: var(--text-secondary);">
                        <span id="pullProgressText">准备中...</span>
                        <span id="pullProgressPercent">0%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                        <div id="pullProgressBar" style="width: 0%; height: 100%; background: var(--primary-gradient); transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <h4 style="margin: 24px 0 12px 0; font-size: 14px; color: var(--text-secondary); display: flex; justify-content: space-between;">
                    已安装模型
                    <button onclick="showStorageInfo()" style="font-size: 12px; color: #3b82f6; background: transparent;">查看存储位置</button>
                </h4>
                <div id="baseModelList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- 存储位置信息 (复用现有结构，仅更新类名) -->
    <div id="storageInfoModal" class="modal-overlay" style="display: none;" onclick="closeStorageInfo()">
        <div class="modal-content" style="max-width: 600px; margin: 10vh auto; padding: 24px;" onclick="event.stopPropagation()">
            <h3 style="margin-top: 0;">存储位置</h3>
            <div id="defaultStoragePath" style="padding: 12px; background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); font-family: monospace; margin: 15px 0;"></div>
            <button onclick="closeStorageInfo()" class="primary" style="width: 100%;">关闭</button>
        </div>
    </div>

    <!-- 智能体编辑器 -->
    <div id="agentEditor" class="modal-overlay" style="display: none;" onclick="closeAgentEditor()">
        <div class="modal-content" style="max-width: 800px; margin: 5vh auto; max-height: 90vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;" id="editorTitle">创建智能体</h3>
                <button onclick="closeAgentEditor()" style="background: transparent; color: var(--text-tertiary); font-size: 20px;">✕</button>
            </div>
            
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">名称</label>
                        <input type="text" id="agentName" placeholder="给助手起个名字" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">底座模型</label>
                        <select id="baseModelSelect" style="width: 100%;"></select>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <label style="font-size: 13px; color: var(--text-secondary);">角色设定 (System Prompt)</label>
                        <button onclick="insertTemplate()" style="font-size: 12px; color: #3b82f6; background: transparent;">插入模板</button>
                    </div>
                    <textarea id="systemPrompt" style="width: 100%; height: 150px; font-family: inherit;" placeholder="描述这个助手的性格、能力和行为准则..."></textarea>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); border-radius: var(--radius-md); padding: 16px;">
                    <h4 style="margin: 0 0 16px 0; font-size: 14px; color: var(--text-secondary);">模型参数</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                <span>创造性 (Temperature)</span>
                                <span id="tempValue" style="color: #3b82f6;">0.8</span>
                            </label>
                            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.8" style="width: 100%;" oninput="updateParamValue('temp', this.value)">
                        </div>
                        <div>
                            <label style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                <span>上下文长度 (Context)</span>
                                <span id="ctxValue" style="color: #3b82f6;">2048</span>
                            </label>
                            <input type="range" id="num_ctx" min="512" max="8192" step="512" value="2048" style="width: 100%;" oninput="updateParamValue('ctx', this.value)">
                        </div>
                    </div>
                    
                    <!-- 隐藏的高级参数，点击展开 -->
                    <details style="margin-top: 15px;">
                        <summary style="font-size: 12px; color: var(--text-tertiary); cursor: pointer;">更多高级参数...</summary>
                        <div style="padding-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                             <div>
                                <label style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                    <span>Top P</span>
                                    <span id="toppValue">0.9</span>
                                </label>
                                <input type="range" id="top_p" min="0" max="1" step="0.05" value="0.9" style="width: 100%;" oninput="updateParamValue('topp', this.value)">
                            </div>
                            <div>
                                <label style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                    <span>Top K</span>
                                    <span id="topkValue">40</span>
                                </label>
                                <input type="range" id="top_k" min="1" max="100" step="1" value="40" style="width: 100%;" oninput="updateParamValue('topk', this.value)">
                            </div>
                            <div>
                                <label style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                    <span>重复惩罚 (Repeat Penalty)</span>
                                    <span id="repeatValue">1.1</span>
                                </label>
                                <input type="range" id="repeat_penalty" min="1" max="2" step="0.1" value="1.1" style="width: 100%;" oninput="updateParamValue('repeat', this.value)">
                            </div>
                            <div>
                                <label style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px;">
                                    <span>随机种子 (Seed)</span>
                                    <span id="seedValue">0</span>
                                </label>
                                <input type="range" id="seed" min="0" max="100" step="1" value="0" style="width: 100%;" oninput="updateParamValue('seed', this.value)">
                            </div>
                            <!-- 隐藏的参数作为隐藏域存在，以兼容 JS -->
                            <input type="hidden" id="num_predict" value="-1">
                            <input type="hidden" id="stop_sequences" value="">
                        </div>
                    </details>
                </div>

                <div id="agentStatus" style="margin-top: 20px; min-height: 20px;"></div>
                
                <div id="manualCreateHint" style="display: none; margin-top: 15px; padding: 15px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; border-radius: 4px;">
                     <div style="color: #f59e0b; font-size: 13px; margin-bottom: 5px;">如自动创建失败，请尝试手动创建：</div>
                     <div id="createCommand" style="font-family: monospace; font-size: 12px; color: var(--text-secondary);"></div>
                </div>
            </div>
            
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 12px;">
                <button onclick="saveAgent()" class="primary" style="flex: 2;">保存并创建</button>
                <button onclick="downloadModelfile()" style="flex: 1; background: var(--bg-card); color: var(--text-secondary);">仅下载 Modelfile</button>
            </div>
        </div>
    </div>

    <script src="js/state.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/main.js"></script>
</body>
</html>